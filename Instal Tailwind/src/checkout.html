<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FatPet - Checkout</title>
  <link href="./output.css" rel="stylesheet" />
  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

<header>
  <nav style="background-color: #E3D0B6;">
    <div class="max-w-screen-xl flex flex-wrap items-center justify-between mx-auto p-4">
      <a href="javascript:void(0)" onclick="history.back()" class="flex items-center space-x-3 rtl:space-x-reverse">
        <ion-icon name="arrow-back-outline" class="text-2xl text-black"></ion-icon>
        <span class="self-center text-2xl font-semibold whitespace-nowrap dark:text-black">FatPet</span>
      </a>
      <a href="profile.html" class="flex items-center text-black hover:text-[#8F5E1C] transition">
        <ion-icon name="person-circle-outline" size="large"></ion-icon>
      </a>
    </div>
  </nav>
</header>

<main class="max-w-6xl mx-auto px-4 py-8 flex flex-row items-start gap-6">
  <div class="flex flex-col w-2/3">
    <section class="bg-white shadow rounded-lg p-4 mb-6">
      <h2 class="text-lg font-semibold mb-4">Barang yang dibeli</h2>
      <div id="checkout-items" class="flex flex-col space-y-4"></div>
    </section>

    <section class="bg-white shadow rounded-lg p-4">
      <h2 class="text-lg font-semibold mb-4">Pengiriman & Pembayaran</h2>
      <div class="mb-4">
        <h3 class="font-semibold">Alamat Pengiriman</h3>
        <p class="text-sm text-gray-700">
          Rumah - Erine<br />
          Tapos depok Gg bp saut rt4/rw10 no 82, Tapos, Kota Depok, Jawa Barat, 081295726063
        </p>
      </div>

      <div class="mb-4">
        <h3 class="font-semibold mb-2">Pilih Pengiriman</h3>
        <div class="grid grid-cols-2 sm:grid-cols-3 gap-2 text-sm">
          <label class="flex items-center space-x-1">
            <input type="radio" name="shipping" value="7000" checked />
            <span>Hemat (Rp7.000)</span>
          </label>
          <label class="flex items-center space-x-1">
            <input type="radio" name="shipping" value="10000" />
            <span>Reguler (Rp10.000)</span>
          </label>
          <label class="flex items-center space-x-1">
            <input type="radio" name="shipping" value="27000" />
            <span>Kargo (Rp27.000)</span>
          </label>
        </div>
      </div>

      <div>
        <h3 class="font-semibold mb-2">Pilih Metode Pembayaran</h3>
        <button class="metode-btn px-4 py-2 border rounded bg-gray-100 mr-2 mb-2">Bayar Di Tempat</button>
        <button class="metode-btn px-4 py-2 border rounded bg-gray-100 mr-2 mb-2">Transfer Bank</button>
        <button class="metode-btn px-4 py-2 border rounded bg-gray-100 mb-2">E-Wallet</button>
      </div>
    </section>
  </div>

<div class="w-1/3">
  <aside class="bg-white shadow rounded-lg p-6 w-full flex flex-col justify-between">
    <div class="flex flex-col gap-4">
      <h2 class="text-xl font-bold">Ringkasan Belanja</h2>

      <div>
        <h3 class="font-semibold mb-1">Total Belanja</h3>
        <div class="flex justify-between text-sm text-gray-600">
          <span>Subtotal</span>
          <span id="checkout-price" class="text-black font-semibold">-</span>
        </div>
        <div class="flex justify-between text-sm text-gray-600">
          <span>Ongkos Kirim</span>
          <span id="shipping-cost" class="text-black font-semibold">Rp7.000</span>
        </div>
      </div>

      <div>
        <h3 class="font-semibold mb-1">Biaya Transaksi</h3>
        <div class="flex justify-between text-sm text-gray-600">
          <span>Biaya Layanan</span>
          <span class="text-black font-semibold">Rp3.000</span>
        </div>
      </div>

      <hr class="my-2 border-gray-300" />
      <div class="flex justify-between font-bold text-lg">
        <span>Total Belanja </span>
        <span id="total-price">-</span>
      </div>
      <hr class="my-2 border-gray-300" />
    </div>

    <button id="btn-pesan" class="mt-4 w-full p-2 text-center bg-[#B7772F] text-white font-bold rounded hover:bg-[#9f5e24] transition">
      Buat Pesanan
    </button>
  </aside>
</div>
</main>

<footer class="bg-white text-black py-12 px-4">
    <div class="max-w-7xl mx-auto grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-6 text-sm">

      <div>
        <h2 class="text-lg font-semibold mb-3">FatPet</h2>
        <p class="text-gray-800 mb-2 text-xs py-3">Terbaik untuk Kebutuhan Hewan Peliharaan Anda</p>
      </div>
  
      <!-- Support -->
      <div>
        <h3 class="font-semibold mb-3">Support</h3>
        <p class="text-black text-xs mb-1 space-y-3">Email</p>
        <p class="text-gray-800 text-xs mb-1 space-y-3">FatPet@gmail.com</p>
        <p class="text-black text-xs mb-1 space-y-3">Contact</p>
        <p class="text-gray-800 text-xs mb-1 space-y-3">+62 | 812-9572-6063</p>
      </div>
  
      <!-- Account -->
      <div>
        <h3 class="font-semibold mb-3">Account</h3>
        <ul class="text-gray-800 text-xs space-y-3">
          <li><a href="profile.html">My Account</a></li>
          <li><a href="cart.html">Cart</a></li>
          <li><a href="#">Wishlist</a></li>
          <li><a href="#">Shop</a></li>
        </ul>
      </div>
  
      <!-- Metode Pembayaran -->
      <div>
        <h3 class="font-semibold mb-3">Metode Pembayaran</h3>
        <div class="grid grid-cols-2 gap-2 items-center">
          <img src="images/Gopay.png" alt="gopay" class="h-4">
          <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR1SpRwqDxJbBTIX-k_dDsdgDdWbhu4TSY6SA&s" alt="BRI" class="h-4">
          <img src="images/ovo.png" alt="OVO" class="h-4">
          <img src="images/BNI.webp" alt="BNI" class="h-4">
          <img src="images/dana.png" alt="DANA" class="h-4">
          <img src="images/alfamart.png" alt="Alfamart" class="h-4">
          <img src="images/klik bca.jpeg" alt="Klik BCA" class="h-4">
          <img src="images/indomart.png" alt="Indomaret" class="h-4">
          <img src="images/mandiri.png" alt="Mandiri" class="h-4">
          <img src="https://storage.googleapis.com/storage-ajaib-prd-platform-wp-artifact/2019/12/Logo-BCA.jpg" alt="BCA" class="h-4">
        </div>
      </div>
  
      <!-- Jasa Pengiriman -->
      <div>
        <h3 class="font-semibold mb-3">Jasa Pengiriman</h3>
        <div class="grid grid-cols-2 gap-2 items-center">
          <img src="images/gosend.png" alt="GoSend" class="h-4">
          <img src="images/jne.png" alt="JNE" class="h-4">
          <img src="images/jnt.png" alt="J&T" class="h-4">
          <img src="images/sicepat.png" alt="SiCepat" class="h-4">
          <img src="images/grab exspress.png" alt="GrabExpress" class="h-4">
          <img src="images/anter aja.jpeg" alt="Anteraja" class="h-4">
          <img src="images/id express.png" alt="ID Express" class="h-4">
          <img src="images/lala move.png" alt="Lalamove" class="h-4">
        </div>
      </div>
  
      <!-- Download App -->
      <div>
        <h3 class="font-semibold mb-3">Download App</h3>
        <p class="text-gray-800 text-xs mb-2">Hemat Rp10.000 khusus pengguna baru</p>
        <div class="space-y-2">
          <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/7/78/Google_Play_Store_badge_EN.svg/512px-Google_Play_Store_badge_EN.svg.png" alt="Google Play" class="w-24 h-auto">
          <img src="https://developer.apple.com/assets/elements/badges/download-on-the-app-store.svg" alt="App Store" class="w-24 h-auto">
        </div>
        <div class="flex space-x-3 text-white mt-4 text-sm">
          <a href="#"><i class="fab fa-facebook-f"></i></a>
          <a href="#"><i class="fab fa-twitter"></i></a>
          <a href="#"><i class="fab fa-instagram"></i></a>
          <a href="#"><i class="fab fa-linkedin-in"></i></a>
        </div>
      </div>
    </div>
  
    <div class="mt-10 text-center text-gray-500 text-xs">
      Â© 2025 FatPet.
    </div>
  </div>
  </footer>
  
<script>
  const checkoutItemsContainer = document.getElementById('checkout-items');
  const checkoutPriceEl = document.getElementById('checkout-price');
  const shippingCostEl = document.getElementById('shipping-cost');
  const totalPriceEl = document.getElementById('total-price');
  const btnPesan = document.getElementById('btn-pesan');
  const metodeButtons = document.querySelectorAll('.metode-btn');

  let shippingCost = 7000;
  const serviceFee = 3000;
  let items = [];
  let totalHargaBarang = 0;

  // Toggle metode pembayaran aktif
  metodeButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      metodeButtons.forEach(b => {
        b.classList.remove('bg-[#B7772F]', 'text-white');
        b.classList.add('bg-gray-100', 'text-black');
      });
      btn.classList.add('bg-[#B7772F]', 'text-white');
      btn.classList.remove('bg-gray-100', 'text-black');
    });
  });

  // Ambil data checkout (detail produk) atau checkout keranjang
  const checkoutData = JSON.parse(localStorage.getItem('checkout')); // dari detail produk
  const keranjangCheckout = JSON.parse(localStorage.getItem('checkoutKeranjang')); // dari keranjang
  if (checkoutData && Array.isArray(checkoutData) && checkoutData.length > 0) {
    items = checkoutData;
    localStorage.removeItem('checkout');
  } else if (keranjangCheckout && Array.isArray(keranjangCheckout) && keranjangCheckout.length > 0) {
    items = keranjangCheckout;
  } else {
    alert("Tidak ada data checkout. Kembali ke halaman utama.");
    window.location.href = "homepage.html";
  }

  function formatRupiah(angka) {
    return 'Rp ' + angka.toLocaleString('id-ID');
  }

  async function renderCheckout() {
    checkoutItemsContainer.innerHTML = "";
    totalHargaBarang = 0;

    for (const [index, item] of items.entries()) {
      try {
        const res = await fetch(`https://fakestoreapi.com/products/${item.id}`);
        if (!res.ok) throw new Error("Gagal ambil data produk");
        const product = await res.json();

        const hargaSatuan = Math.round(product.price * 1600);
        const subtotal = hargaSatuan * item.jumlah;
        totalHargaBarang += subtotal;

        const itemEl = document.createElement('div');
        itemEl.className = "flex gap-4 items-center";
        itemEl.innerHTML = `
          <img src="${product.image}" alt="${product.title}" class="w-16 h-16 object-contain rounded" />
          <div class="flex-1 min-w-0">
            <p class="font-semibold truncate">${product.title}</p>
            <p class="text-sm text-gray-600">
              Harga: ${formatRupiah(hargaSatuan)}<br/>
            </p>
            <label for="quantity-${index}" class="font-semibold mb-1 block">Jumlah:</label>
            <div class="flex items-center space-x-2 max-w-xs">
              <button id="qty-minus-${index}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">-</button>
              <input type="number" id="quantity-${index}" class="w-16 text-center border border-gray-300 rounded" min="1" value="${item.jumlah}" />
              <button id="qty-plus-${index}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">+</button>
            </div>
              Subtotal: <b id="subtotal-${index}">${formatRupiah(subtotal)}</b>
          </div>
          <button class="hapus-checkout-btn text-red-500 hover:text-red-700" title="Hapus produk" aria-disabled="false">
            <ion-icon name="remove-circle-outline" class="text-2xl"></ion-icon>
          </button>
        `;

        checkoutItemsContainer.appendChild(itemEl);

        document.getElementById(`qty-minus-${index}`).addEventListener('click', () => {
          updateQuantity(index, -1);
        });

        document.getElementById(`qty-plus-${index}`).addEventListener('click', () => {
          updateQuantity(index, 1);
        });

        document.getElementById(`quantity-${index}`).addEventListener('input', (e) => {
          let val = parseInt(e.target.value);
          if (isNaN(val) || val < 1) {
            e.target.value = 1;
            val = 1;
          }
          items[index].jumlah = val;
          updateTotals();
        });

      } catch (error) {
        console.error("Gagal ambil produk:", error);
      }
    }

    // Tambahan: fungsi hapus dengan konfirmasi dan validasi
    const hapusBtns = document.querySelectorAll('.hapus-checkout-btn');
    if (items.length === 1) {
      hapusBtns.forEach(btn => btn.style.display = 'none');
    } else {
      hapusBtns.forEach((btn, i) => {
        btn.addEventListener('click', () => {
          const konfirmasi = confirm("Yakin ingin menghapus produk ini?");
          if (konfirmasi) {
            items.splice(i, 1);
            localStorage.setItem('checkoutKeranjang', JSON.stringify(items));
            renderCheckout();
          }
        });
      });
    }

    updateTotals();
  }

  function updateQuantity(index, increment) {
    let qtyInput = document.getElementById(`quantity-${index}`);
    let currentQty = parseInt(qtyInput.value) || 1;
    let newQty = currentQty + increment;
    if (newQty < 1) newQty = 1;
    qtyInput.value = newQty;
    items[index].jumlah = newQty;
    updateTotals();
  }

  async function updateTotals() {
    totalHargaBarang = 0;
    for (const [index, item] of items.entries()) {
      try {
        const res = await fetch(`https://fakestoreapi.com/products/${item.id}`);
        if (!res.ok) throw new Error("Gagal ambil data produk");
        const product = await res.json();

        const hargaSatuan = Math.round(product.price * 1600);
        const subtotal = hargaSatuan * item.jumlah;
        totalHargaBarang += subtotal;

        const subtotalEl = document.getElementById(`subtotal-${index}`);
        if (subtotalEl) {
          subtotalEl.textContent = formatRupiah(subtotal);
        }
      } catch (error) {
        console.error("Gagal update subtotal produk:", error);
      }
    }

    checkoutPriceEl.textContent = formatRupiah(totalHargaBarang);
    shippingCostEl.textContent = formatRupiah(shippingCost);
    totalPriceEl.textContent = formatRupiah(totalHargaBarang + shippingCost + serviceFee);
  }

  document.querySelectorAll('input[name="shipping"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
      shippingCost = parseInt(e.target.value);
      shippingCostEl.textContent = formatRupiah(shippingCost);
      totalPriceEl.textContent = formatRupiah(totalHargaBarang + shippingCost + serviceFee);
    });
  });

 btnPesan.addEventListener('click', async () => {
  // Ambil data transaksi yang sudah ada
  let daftarTransaksi = JSON.parse(localStorage.getItem('daftarTransaksi')) || [];

  // Buat ID transaksi unik (pakai timestamp)
  const transaksiId = Date.now().toString();

  // Ambil data produk lengkap (image + title) dari API
  const itemsWithDetail = await Promise.all(
    items.map(async (item) => {
      const res = await fetch(`https://fakestoreapi.com/products/${item.id}`);
      const product = await res.json();
      return {
        id: item.id,
        jumlah: item.jumlah,
        title: product.title,
        image: product.image
      };
    })
  );

  // Hitung total akhir
  const totalAkhir = totalHargaBarang + shippingCost + serviceFee;

  // Buat objek transaksi baru
  const transaksiBaru = {
    id: transaksiId,
    tanggal: new Date().toLocaleDateString('id-ID', {
      day: '2-digit',
      month: 'long',
      year: 'numeric'
    }),
    items: itemsWithDetail,
    total: totalAkhir,
    status: "Sedang Dikirim"
  };

  // Cek apakah transaksi dengan ID yang sama sudah pernah disimpan
  const sudahAda = daftarTransaksi.some(t => t.id === transaksiBaru.id);
  if (!sudahAda) {
    daftarTransaksi.push(transaksiBaru);
    localStorage.setItem('daftarTransaksi', JSON.stringify(daftarTransaksi));
  }

  // Hapus data checkout
  localStorage.removeItem('checkout');
  localStorage.removeItem('checkoutKeranjang');

  alert("Pesanan berhasil dibuat. Terima kasih sudah belanja di FatPet!");
  window.location.href = 'DaftarTransaksi.html';
});

  renderCheckout();
</script>

</body>
</html>
